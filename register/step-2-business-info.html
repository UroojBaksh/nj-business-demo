<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Your Business - Step 2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/tracking.js" defer></script>
  <script src="../js/debug-helper.js" defer></script>
  <script src="../js/ui.js" defer></script>
</head>
<body>
  <div class="container-nj mt-4">
    <div class="step-toolbar">
      <div class="left">
        <a class="btn-nj btn-ghost-nj btn-sm-nj" href="./step-1-business-type.html">← Back</a>
        <h2 class="m-0">Step 2: Business Info</h2>
      </div>
    </div>

    <div class="progress mb-3" style="height: 26px;">
      <div class="progress-bar" role="progressbar" style="width: 50%">Step 2 of 4</div>
    </div>

    <form id="businessInfoForm" class="card-nj">
      <div class="mb-4">
        <label class="form-label" for="businessName">Legal Business Name *</label>
        <input 
          class="form-control input-tokenized" 
          required 
          id="businessName" 
          name="businessName"
          type="text"
          placeholder="Enter your business name"
        />
      </div>

      <div class="mb-4">
        <label class="form-label" for="ein">Employer Identification Number (EIN) *</label>
        <input 
          class="form-control input-tokenized" 
          id="ein" 
          name="ein" 
          type="text"
          placeholder="Format: 12-3456789" 
          pattern="^[0-9-]{9,10}$" 
          required 
        />
        <div class="form-text">Format: 12-3456789 or 123456789</div>
      </div>

      <div class="mb-4">
        <label class="form-label" for="county">County *</label>
        <select class="form-select" id="county" name="county" required>
          <option value="">Select county...</option>
          <option value="Bergen">Bergen</option>
          <option value="Essex">Essex</option>
          <option value="Middlesex">Middlesex</option>
          <option value="Monmouth">Monmouth</option>
          <option value="Camden">Camden</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="form-label" for="language">Preferred Language *</label>
        <select class="form-select" id="language" name="language" required>
          <option value="">Select language...</option>
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <a class="btn-nj btn-ghost-nj" href="./step-1-business-type.html">← Back</a>
        <button type="submit" class="btn-nj btn-primary-nj">Continue to Owner Info →</button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('businessInfoForm');
      const start = Date.now();

      // Track page view and form start
      if (typeof window.njTrack === 'function') {
        window.njTrack('form_step_viewed', {
          step_number: 2,
          step_name: 'business_info'
        });

        window.njTrack('form_start', {
          form_name: 'business_registration',
          form_id: 'form_step_2',
          total_fields: form.querySelectorAll('input, select').length
        });
      }

      // Track field interactions
      const formFields = form.querySelectorAll('input, select');
      formFields.forEach(field => {
        // Track focus
        field.addEventListener('focus', () => {
          if (typeof window.njTrack === 'function') {
            window.njTrack('form_field_focus', {
              field_name: field.name,
              field_id: field.id,
              form_id: 'form_step_2'
            });
          }
        });

        // Track change/completion
        field.addEventListener('change', () => {
          if (field.value && typeof window.njTrack === 'function') {
            window.njTrack('form_field_complete', {
              field_name: field.name,
              field_id: field.id,
              form_id: 'form_step_2',
              is_valid: field.checkValidity()
            });
          }
        });

        // Track blur/validation errors
        field.addEventListener('blur', () => {
          if (!field.checkValidity() && field.value) {
            if (typeof window.njTrack === 'function') {
              window.njTrack('form_validation_error', {
                field_name: field.name,
                field_id: field.id,
                error_type: field.type,
                error_message: field.validationMessage
              });
            }
          }
        });
      });

      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const fd = new FormData(form);
        const name = fd.get('businessName');
        const ein = fd.get('ein');
        const county = fd.get('county');
        const language = fd.get('language');
        const timeSpent = Math.round((Date.now() - start) / 1000);

        // Validate EIN format
        if (!/^[0-9-]{9,10}$/.test(ein)) {
          if (typeof window.njTrack === 'function') {
            window.njTrack('form_validation_error', {
              field_name: 'ein',
              error_type: 'pattern',
              error_message: 'Invalid EIN format. Use 12-3456789 or 123456789'
            });
          }
          alert('Invalid EIN format. Please use 12-3456789 or 123456789');
          return;
        }

        // Save data to session
        sessionStorage.setItem('business_name', name);
        sessionStorage.setItem('ein', ein);
        sessionStorage.setItem('county', county);
        sessionStorage.setItem('preferred_language', language);
        sessionStorage.setItem('registration_step_2', JSON.stringify({
          businessName: name,
          ein,
          county,
          language,
          completionTime: Date.now() - start
        }));

        // Update registration status
        sessionStorage.setItem('registration_status', 'in_progress');
        sessionStorage.setItem('last_completed_step', '2');

        // Track step completion
        if (typeof window.njTrack === 'function') {
          window.njTrack('registration_step_complete', {
            step_number: 2,
            step_name: 'business_info',
            time_spent: timeSpent,
            fields_completed: 4,
            business_name: name,
            county: county,
            language: language
          });
        }

        // Navigate to next step
        setTimeout(() => {
          window.location.href = './step-3-owner-info.html';
        }, 200);
      });

      // Track abandonment if user leaves
      window.addEventListener('beforeunload', function() {
        const status = sessionStorage.getItem('registration_status');
        if (status === 'in_progress' && sessionStorage.getItem('last_completed_step') === '1') {
          const timeOnPage = Math.round((Date.now() - start) / 1000);
          if (typeof window.njTrack === 'function') {
            window.njTrack('registration_abandoned', {
              step_number: 2,
              last_completed_step: 1,
              time_on_page: timeOnPage,
              reason: 'page_exit'
            });
          }
        }
      });
    });
  </script>
</body>
</html>
