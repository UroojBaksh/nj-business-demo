<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Your Business - Step 1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/tracking.js" defer></script>
</head>
<body>
  <div class="container-nj mt-5">
    <div class="progress mb-4" style="height: 30px;">
      <div class="progress-bar" role="progressbar" style="width: 25%">Step 1 of 4: Business Type</div>
    </div>

    <form id="businessTypeForm" class="card-nj">
      <div class="mb-4">
        <h3>Select Your Business Entity Type</h3>
        <div class="form-check"><input class="form-check-input" type="radio" name="entityType" id="llc" value="LLC" required><label class="form-check-label" for="llc"><strong>Limited Liability Company (LLC)</strong><small class="d-block text-muted">Most popular, protects personal assets</small></label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="entityType" id="corp" value="Corporation"><label class="form-check-label" for="corp"><strong>Corporation</strong><small class="d-block text-muted">Best for raising capital</small></label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="entityType" id="nonprofit" value="NonProfit"><label class="form-check-label" for="nonprofit"><strong>Non-Profit</strong><small class="d-block text-muted">Mission-driven organizations</small></label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="entityType" id="sole" value="SoleProprietor"><label class="form-check-label" for="sole"><strong>Sole Proprietor</strong><small class="d-block text-muted">Simple and fast</small></label></div>
      </div>

      <div class="mb-4">
        <label for="industry" class="form-label">Industry Category</label>
        <select class="form-select" id="industry" name="industry" required>
          <option value="">Choose your industry...</option>
          <option value="food_service">Food Service & Restaurant</option>
          <option value="retail">Retail & E-commerce</option>
          <option value="professional">Professional Services</option>
          <option value="technology">Technology & Software</option>
          <option value="construction">Construction & Trades</option>
          <option value="healthcare">Healthcare & Medical</option>
        </select>
      </div>

      <div class="mb-4">
        <h3>Ownership Demographics (Optional)</h3>
        <p class="text-muted">Check all that apply for potential certification benefits</p>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="mwbe[]" value="minority_owned" id="minority"><label class="form-check-label" for="minority">Minority-Owned Business</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="mwbe[]" value="women_owned" id="women"><label class="form-check-label" for="women">Women-Owned Business</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="mwbe[]" value="veteran_owned" id="veteran"><label class="form-check-label" for="veteran">Veteran-Owned Business</label></div>
        <div class="form-check"><input class="form-check-input" type="checkbox" name="mwbe[]" value="disabled_owned" id="disabled"><label class="form-check-label" for="disabled">Disabled-Owned Business</label></div>
      </div>

      <div class="mb-4">
        <label for="region" class="form-label">New Jersey Region</label>
        <select class="form-select" id="region" name="region" required>
          <option value="">Select your region...</option>
          <option value="North">North Jersey</option>
          <option value="Central">Central Jersey</option>
          <option value="South">South Jersey</option>
        </select>
      </div>

      <button type="submit" class="btn-nj btn-primary-nj btn-lg">Continue to Business Info â†’</button>
    </form>
  </div>

  <script>
  // Begin registration on page load
  document.addEventListener('DOMContentLoaded', function(){
    window.njTrack('begin_registration', { entry_point: 'direct_load', device_type: (window.innerWidth<768? 'mobile':'desktop') });
  });

  class FormTracker {
    constructor(formId) { this.form = document.getElementById(formId); this.startTime = Date.now(); this.fieldInteractions = {}; this.init(); }
    init() {
      window.njTrack('form_start', { form_name: 'business_registration', form_id: 'form_step_1', total_fields: this.form.querySelectorAll('input, select, textarea').length });
      this.trackFieldInteractions(); this.trackFormSubmission(); this.trackAbandonment();
    }
    trackFieldInteractions(){
      const fields = this.form.querySelectorAll('input, select, textarea');
      fields.forEach(field => {
        let t0; field.addEventListener('focus', ()=>{ t0=Date.now(); this.fieldInteractions[field.name] = this.fieldInteractions[field.name] || { touches:0,totalTime:0,completed:false }; this.fieldInteractions[field.name].touches++; window.njTrack('form_field_focus', { field_name: field.name, field_type: field.type, touch_number: this.fieldInteractions[field.name].touches }); });
        field.addEventListener('blur', ()=>{ const dt=Date.now()-t0; this.fieldInteractions[field.name].totalTime += dt; this.fieldInteractions[field.name].completed = field.value!==''; window.njTrack('form_field_complete', { field_name: field.name, time_spent_ms: dt, total_time_ms: this.fieldInteractions[field.name].totalTime, field_completed: this.fieldInteractions[field.name].completed, value_length: (field.value||'').length }); window.njForm.progress(this.form); });
        if (field.tagName==='SELECT') field.addEventListener('change', ()=> window.njTrack('form_dropdown_selection', { field_name: field.name, selected_value: field.value, selected_text: field.options[field.selectedIndex]?.text }));
        if (field.type==='checkbox' || field.type==='radio') field.addEventListener('change', ()=> window.njTrack('form_option_toggle', { field_name: field.name, field_value: field.value, is_checked: field.checked }));
      });
    }
    trackFormSubmission(){
      this.form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(this.form); const totalTime = Date.now()-this.startTime; const mwbe = fd.getAll('mwbe[]');
        // Persist to session
        sessionStorage.setItem('registration_status','in_progress');
        sessionStorage.setItem('business_type', fd.get('entityType'));
        sessionStorage.setItem('industry_category', fd.get('industry'));
        sessionStorage.setItem('geographic_region', fd.get('region'));
        sessionStorage.setItem('mwbe_minority', String(mwbe.includes('minority_owned')));
        sessionStorage.setItem('mwbe_women', String(mwbe.includes('women_owned')));
        sessionStorage.setItem('mwbe_veteran', String(mwbe.includes('veteran_owned')));
        sessionStorage.setItem('mwbe_disabled', String(mwbe.includes('disabled_owned')));
        sessionStorage.setItem('registration_step_1', JSON.stringify({ entityType: fd.get('entityType'), industry: fd.get('industry'), mwbeStatus: mwbe, region: fd.get('region'), completionTime: totalTime }));

        window.njTrack('registration_step_complete', { step_number: 1, step_name: 'business_type', time_spent: Math.round(totalTime/1000), fields_completed: Object.keys(this.fieldInteractions).length });
        setTimeout(()=>{ window.location.href = './step-2-business-info.html'; }, 250);
      });
    }
    trackAbandonment(){
      window.addEventListener('beforeunload', ()=>{
        const total = this.form.elements.length; const filled = Array.from(this.form.elements).filter(f=>f.value!=='').length; const rate = total>0? Math.round((filled/total)*100):0;
        if (rate<100){ navigator.sendBeacon('/track', JSON.stringify({ event: 'registration_abandoned', last_step: 1, completion_percentage: rate, abandonment_reason: 'navigation', user_id: sessionStorage.getItem('user_id'), session_id: sessionStorage.getItem('session_id') })); }
      });
    }
  }
  document.addEventListener('DOMContentLoaded', ()=> new FormTracker('businessTypeForm'));
  </script>
</body>
</html>
