<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Permits & Licenses</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="../js/tracking.js" defer></script>
  <script src="../js/debug-helper.js" defer></script>
</head>
<body>
  <div class="container-nj mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Required Permits for Your Business</h1>
      <div>
        <a class="btn-nj btn-secondary-nj me-2" href="../index.html">Portal Home</a>
        <a class="btn-nj btn-primary-nj" href="./checkout.html">Checkout (<span id="cartCounter">0</span>)</a>
      </div>
    </div>
    <div id="permitCatalog" class="row"></div>
  </div>

  <script>
  class EcommerceTracker {
    constructor() {
      this.cart = JSON.parse(sessionStorage.getItem('permit_cart') || '[]');
      this.permits = [
        { item_id: 'PERMIT_001', item_name: 'Basic Business License', item_category: 'License', item_category2: 'Required', price: 75.00, description: 'Required for all businesses', processing_time: '5-7 days', business_requirement: 'Required' },
        { item_id: 'PERMIT_002', item_name: 'Food Service Permit', item_category: 'Permit', item_category2: 'Food_Industry', price: 150.00, description: 'Required for food service establishments', processing_time: '10-14 days', business_requirement: 'Industry' },
        { item_id: 'PERMIT_003', item_name: 'Liquor License', item_category: 'License', item_category2: 'Alcohol', price: 2500.00, description: 'Required for alcohol sales', processing_time: '30-45 days', business_requirement: 'Conditional' },
        { item_id: 'PERMIT_004', item_name: 'Fire Safety Certificate', item_category: 'Certificate', item_category2: 'Safety', price: 200.00, description: 'Required for public-facing businesses', processing_time: '7-10 days', business_requirement: 'Required' }
      ];
      this.init();
    }
    init() { this.renderCatalog(); this.trackItemListView(); this.updateCartCounter(); }
    renderCatalog() {
      const catalogDiv = document.getElementById('permitCatalog');
      this.permits.forEach((permit, index) => {
        const card = document.createElement('div');
        card.className = 'col-md-6 mb-4';
        card.innerHTML = `
          <div class="card-nj h-100" data-permit-id="${permit.item_id}">
            <div>
              <h5>${permit.item_name}</h5>
              <p>${permit.description}</p>
              <p class="text-muted">Processing: ${permit.processing_time}</p>
              <h4 style="color: hsl(var(--primary))">$${permit.price.toFixed(2)}</h4>
              <div class="d-flex gap-2">
                <button class="btn-nj btn-secondary-nj view-details" data-index="${index}">View Details</button>
                <button class="btn-nj btn-success-nj add-to-cart" data-index="${index}">Add to Application</button>
              </div>
            </div>
          </div>`;
        catalogDiv.appendChild(card);
      });
      this.attachEventListeners();
    }
    attachEventListeners() {
      document.querySelectorAll('.view-details').forEach(button => { button.addEventListener('click', (e) => { const index = e.target.dataset.index; this.trackViewItem(this.permits[index]); }); });
      document.querySelectorAll('.add-to-cart').forEach(button => { button.addEventListener('click', (e) => { const index = e.target.dataset.index; this.addToCart(this.permits[index]); }); });
    }
    trackItemListView() {
      window.njTrack('view_item_list', { item_list_id: 'permit_catalog', item_list_name: 'All Business Permits', items: this.permits.map((p, i) => ({...p, index: i, quantity: 1})) });
    }
    mapToDetails(permit) { switch(permit.item_id) { case 'PERMIT_002': return 'food-permit.html'; case 'PERMIT_003': return 'liquor-permit.html'; default: return 'food-permit.html'; } }
    trackViewItem(permit) {
      window.njTrack('view_item', { permit_id: permit.item_id, permit_name: permit.item_name, permit_category: permit.item_category, price: permit.price });
      window.location.href = this.mapToDetails(permit);
    }
    addToCart(permit) {
      const existingIndex = this.cart.findIndex(item => item.item_id === permit.item_id);
      if (existingIndex === -1) {
        this.cart.push({...permit, quantity: 1});
        window.njTrack('add_to_cart', { permit_id: permit.item_id, quantity: 1, price: permit.price, business_requirement: permit.business_requirement });
        sessionStorage.setItem('permit_cart', JSON.stringify(this.cart));
        this.showNotification(`${permit.item_name} added to application!`);
        this.updateCartCounter();
      } else { this.showNotification('This permit is already in your application', 'warning'); }
    }
    showNotification(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
      alertDiv.style.zIndex = '9999'; alertDiv.innerHTML = `<strong>${message}</strong> <a class="ms-2" href="./checkout.html">Go to Checkout â†’</a>`;
      document.body.appendChild(alertDiv);
      setTimeout(() => { alertDiv.remove(); }, 2600);
    }
    updateCartCounter() { const counter = document.getElementById('cartCounter'); if (counter) counter.textContent = this.cart.length; }
    // Ensure banner is focus-visible for a11y
    focusBanner(){ const el = document.querySelector('.alert.position-fixed'); if (el){ el.setAttribute('tabindex','-1'); el.focus({preventScroll:true}); } }
  }
  document.addEventListener('DOMContentLoaded', () => { new EcommerceTracker(); });
  </script>
</body>
</html>
